<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#4a6fa5">
  <title>Результаты тестов</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" href="icon-192.png">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>Результаты тестирования</h1>
      <p class="subtitle">Анализ ваших управленческих компетенций</p>
    </header>

    <!-- Ваш последний результат -->
    <div class="last-result-card">
      <h3>Ваш последний результат</h3>
      <div class="result-score" id="lastResult">
        <div class="score-circle">
          <span id="lastScore">0</span>
          <small>баллов</small>
        </div>
        <div class="result-details">
          <h4 id="lastLevel">Новичок</h4>
          <p>Максимальный балл: 45</p>
        </div>
      </div>
    </div>

    <!-- Общая статистика -->
    <div class="stats-section">
      <h3>Статистика тестирования</h3>
      <div id="statsInfo" class="stats-loading">Загрузка статистики...</div>
    </div>

    <!-- История результатов -->
    <div class="history-section">
      <div class="section-header">
        <h3>История прохождений</h3>
        <span class="results-count" id="resultsCount">0 результатов</span>
      </div>
      <div id="resultsList" class="results-list">Загрузка...</div>
    </div>

    <div class="actions">
      <button class="btn-primary" onclick="window.location.href='test.html'">Пройти тест еще раз</button>
      <button class="btn-secondary" onclick="window.location.href='index.html'">Вернуться к началу</button>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAmTtXSLeksMmRuxlmt19qz60zESOCFGGY",
      authDomain: "manager-test-2b964.firebaseapp.com",
      projectId: "manager-test-2b964",
      storageBucket: "manager-test-2b964.firebasestorage.app",
      messagingSenderId: "769825814408",
      appId: "1:769825814408:web:072ec41246a2d1027b6c3d"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Показываем последний результат из localStorage
    document.getElementById('lastScore').textContent = localStorage.getItem('lastScore') || '0';
    document.getElementById('lastLevel').textContent = localStorage.getItem('lastLevel') || 'Нет данных';

    // Загружаем статистику
    db.collection("results")
      .orderBy("timestamp", "desc")
      .get()
      .then(snapshot => {
        const list = document.getElementById('resultsList');
        const stats = document.getElementById('statsInfo');
        const resultsCount = document.getElementById('resultsCount');
        
        if (snapshot.empty) {
          list.innerHTML = `
            <div class="empty-state">
              <p>Нет сохранённых результатов</p>
              <button onclick="window.location.href='test.html'" class="btn-primary">Пройти тест первым</button>
            </div>
          `;
          stats.innerHTML = `
            <div class="stats-empty">
              <p>Пока нет статистики</p>
              <p>Пройдите тест, чтобы увидеть статистику</p>
            </div>
          `;
          resultsCount.textContent = "0 результатов";
          return;
        }

        let html = '';
        let totalResults = snapshot.size;
        resultsCount.textContent = `${totalResults} результатов`;
        
        // Счетчики для уровней
        let levelCounts = {
          "Новичок": 0,
          "Опытный менеджер": 0,
          "Профессионал высокого уровня": 0
        };
        
        // Средний балл
        let totalScore = 0;
        let yourResults = 0;

        // Считаем результаты
        snapshot.forEach(doc => {
          const data = doc.data();
          const name = data.firstName && data.lastName 
            ? `${data.firstName} ${data.lastName}`
            : "Аноним";
          const date = data.timestamp 
            ? new Date(data.timestamp.toDate()).toLocaleDateString('ru-RU', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
              })
            : 'Неизвестно';

          // Проверяем, ваш ли это результат
          const isYou = data.firstName === localStorage.getItem('firstName') && 
                       data.lastName === localStorage.getItem('lastName');
          
          if (isYou) yourResults++;

          // Увеличиваем счётчик для уровня
          if (data.level && levelCounts.hasOwnProperty(data.level)) {
            levelCounts[data.level]++;
          }
          
          // Считаем общий балл
          if (data.score) {
            totalScore += data.score;
          }

          // Определяем цвет уровня
          let levelColor = '#ff6b6b'; // Красный для новичка
          let levelClass = 'level-novice';
          if (data.level === "Опытный менеджер") {
            levelColor = '#4d96ff';
            levelClass = 'level-experienced';
          }
          if (data.level === "Профессионал высокого уровня") {
            levelColor = '#6bcf7f';
            levelClass = 'level-professional';
          }

          html += `
            <div class="result-item ${isYou ? 'your-result' : ''}">
              <div class="result-header">
                <span class="user-name">${name}</span>
                ${isYou ? '<span class="you-badge">Вы</span>' : ''}
                <span class="result-date">${date}</span>
              </div>
              <div class="result-body">
                <span class="level-badge ${levelClass}">${data.level}</span>
                <span class="score">${data.score} баллов</span>
              </div>
            </div>
          `;
        });
        
        list.innerHTML = html;
        
        // Показываем статистику
        const averageScore = totalResults > 0 ? (totalScore / totalResults).toFixed(1) : 0;
        const yourPercentage = totalResults > 0 ? ((yourResults / totalResults) * 100).toFixed(1) : 0;
        
        stats.innerHTML = `
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value">${totalResults}</div>
              <div class="stat-label">Всего тестов</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${averageScore}</div>
              <div class="stat-label">Средний балл</div>
            </div>
            <div class="stat-card">
              <div class="stat-value">${yourResults}</div>
              <div class="stat-label">Ваших тестов</div>
            </div>
          </div>
          
          <div class="levels-distribution">
            <h4>Распределение по уровням:</h4>
            <div class="level-dist-item">
              <div class="level-info">
                <span class="level-dot" style="background: #ff6b6b"></span>
                <span>Новичок</span>
              </div>
              <div class="level-stats">
                <span>${levelCounts["Новичок"]} чел.</span>
                <span>${((levelCounts["Новичок"] / totalResults) * 100).toFixed(1)}%</span>
              </div>
            </div>
            <div class="level-dist-item">
              <div class="level-info">
                <span class="level-dot" style="background: #4d96ff"></span>
                <span>Опытный менеджер</span>
              </div>
              <div class="level-stats">
                <span>${levelCounts["Опытный менеджер"]} чел.</span>
                <span>${((levelCounts["Опытный менеджер"] / totalResults) * 100).toFixed(1)}%</span>
              </div>
            </div>
            <div class="level-dist-item">
              <div class="level-info">
                <span class="level-dot" style="background: #6bcf7f"></span>
                <span>Профессионал</span>
              </div>
              <div class="level-stats">
                <span>${levelCounts["Профессионал высокого уровня"]} чел.</span>
                <span>${((levelCounts["Профессионал высокого уровня"] / totalResults) * 100).toFixed(1)}%</span>
              </div>
            </div>
          </div>
        `;
        
      })
      .catch(err => {
        console.error("Ошибка загрузки:", err);
        document.getElementById('resultsList').innerHTML = `
          <div class="error-state">
            <p>Ошибка при загрузке данных</p>
            <p>Проверьте подключение к интернету</p>
          </div>
        `;
        document.getElementById('statsInfo').innerHTML = `
          <div class="error-state">
            <p>Не удалось загрузить статистику</p>
          </div>
        `;
      });
      
    // Регистрация Service Worker для PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/manager-test/sw.js')
          .then(registration => {
            console.log('Service Worker зарегистрирован:', registration);
          })
          .catch(error => {
            console.log('Ошибка регистрации Service Worker:', error);
          });
      });
    }
  </script>
</body>
</html>
