<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Результаты тестов</title>
  <link rel="stylesheet" href="styles.css?v=1.5">
</head>
<body>
  <div class="container">
    <h2>Результаты прохождения теста</h2>
    
    <!-- CSS Диаграмма -->
    <div class="chart-container">
      <h3>Распределение уровней менеджеров</h3>
      <div class="css-chart">
        <div class="chart-pie" id="chartPie">
          <!-- Сегменты диаграммы будут вставлены через JS -->
        </div>
        <div class="chart-legend" id="chartLegend"></div>
      </div>
      <div id="chartStats" class="chart-stats"></div>
    </div>
    
    <!-- Список результатов -->
    <h3>Детальные результаты</h3>
    <div id="list">Загрузка...</div>
    
    <button onclick="window.location.href='index.html'" style="margin-top: 30px;">Вернуться к началу</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAmTtXSLeksMmRuxlmt19qz60zESOCFGGY",
      authDomain: "manager-test-2b964.firebaseapp.com",
      projectId: "manager-test-2b964",
      storageBucket: "manager-test-2b964.firebasestorage.app",
      messagingSenderId: "769825814408",
      appId: "1:769825814408:web:072ec41246a2d1027b6c3d"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Счётчики для уровней
    let levelCounts = {
      "Новичок": 0,
      "Опытный менеджер": 0,
      "Профессионал высокого уровня": 0
    };

    // Загружаем результаты и строим диаграмму
    db.collection("results")
      .orderBy("timestamp", "desc")
      .get()
      .then(snapshot => {
        const list = document.getElementById('list');
        if (snapshot.empty) {
          list.innerHTML = "<p>Нет сохранённых результатов.</p>";
          document.getElementById('chartStats').innerHTML = "<p>Нет данных для диаграммы</p>";
          return;
        }

        let html = '';
        let totalResults = snapshot.size;
        
        // Считаем количество по уровням
        snapshot.forEach(doc => {
          const data = doc.data();
          const name = data.firstName && data.lastName 
            ? `${data.firstName} ${data.lastName}`
            : "Аноним";
          const date = data.timestamp 
            ? new Date(data.timestamp.toDate()).toLocaleString('ru-RU')
            : 'Неизвестно';

          // Увеличиваем счётчик для уровня
          if (data.level && levelCounts.hasOwnProperty(data.level)) {
            levelCounts[data.level]++;
          }

          html += `
            <div class="result-item">
              <p><strong>${name}</strong> — ${data.level} (баллы: ${data.score})</p>
              <p><small>Дата: ${date}</small></p>
            </div>
          `;
        });
        
        list.innerHTML = html;
        
        // Строим CSS диаграмму
        createCSSChart(levelCounts, totalResults);
        
      })
      .catch(err => {
        console.error("Ошибка загрузки:", err);
        document.getElementById('list').innerHTML = "<p>Ошибка при загрузке данных.</p>";
      });

    // Функция создания CSS круговой диаграммы
    function createCSSChart(levelCounts, total) {
      const pieContainer = document.getElementById('chartPie');
      const legendContainer = document.getElementById('chartLegend');
      const statsElement = document.getElementById('chartStats');
      
      const labels = Object.keys(levelCounts);
      const data = Object.values(levelCounts);
      const percentages = data.map(count => total > 0 ? ((count / total) * 100).toFixed(1) : 0);
      
      // Цвета для диаграммы в стиле программиста
      const colors = [
        'rgba(255, 99, 132, 0.8)',    // Красный для новичков
        'rgba(54, 162, 235, 0.8)',    // Синий для опытных
        'rgba(0, 255, 0, 0.8)'        // Зелёный для профессионалов
      ];
      
      // Очищаем контейнеры
      pieContainer.innerHTML = '';
      legendContainer.innerHTML = '';
      
      if (total === 0) {
        pieContainer.innerHTML = '<div class="no-data">Нет данных для диаграммы</div>';
        statsElement.innerHTML = '<p>Нет результатов для отображения</p>';
        return;
      }
      
      let cumulativePercentage = 0;
      let pieHTML = '';
      let legendHTML = '';
      
      // Создаем сегменты диаграммы
      data.forEach((count, index) => {
        const percentage = parseFloat(percentages[index]);
        
        if (percentage > 0) {
          const rotate = cumulativePercentage * 3.6; // 1% = 3.6 градуса
          const color = colors[index];
          
          pieHTML += `
            <div class="chart-segment" 
                 style="--percentage: ${percentage}; 
                        --rotate: ${rotate}deg; 
                        --color: ${color}; 
                        --index: ${index}">
            </div>
          `;
          
          cumulativePercentage += percentage;
          
          // Добавляем элемент в легенду
          legendHTML += `
            <div class="legend-item">
              <span class="legend-color" style="background-color: ${color}"></span>
              <span class="legend-label">${labels[index]}:</span>
              <span class="legend-value">${count} (${percentage}%)</span>
            </div>
          `;
        }
      });
      
      pieContainer.innerHTML = pieHTML;
      legendContainer.innerHTML = legendHTML;
      
      // Показываем статистику
      let statsHTML = '<div class="stats-grid">';
      
      labels.forEach((label, i) => {
        const count = data[i];
        const percent = percentages[i];
        const color = colors[i];
        
        statsHTML += `
          <div class="stat-item">
            <span class="stat-color" style="background-color: ${color}"></span>
            <span class="stat-label">${label}:</span>
            <span class="stat-value">${count} (${percent}%)</span>
          </div>
        `;
      });
      
      statsHTML += `
        <div class="stat-total">
          <span class="stat-label">Всего результатов:</span>
          <span class="stat-value">${total}</span>
        </div>
      </div>`;
      
      statsElement.innerHTML = statsHTML;
    }
  </script>
</body>
</html>
