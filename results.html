<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Результаты тестов</title>
  <link rel="stylesheet" href="styles.css?v=1.4">
  <!-- Подключаем Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container">
    <h2>Результаты прохождения теста</h2>
    
    <!-- Диаграмма -->
    <div class="chart-container">
      <h3>Распределение уровней менеджеров</h3>
      <canvas id="levelChart"></canvas>
      <div id="chartStats" class="chart-stats"></div>
    </div>
    
    <!-- Список результатов -->
    <h3>Детальные результаты</h3>
    <div id="list">Загрузка...</div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAmTtXSLeksMmRuxlmt19qz60zESOCFGGY",
      authDomain: "manager-test-2b964.firebaseapp.com",
      projectId: "manager-test-2b964",
      storageBucket: "manager-test-2b964.firebasestorage.app",
      messagingSenderId: "769825814408",
      appId: "1:769825814408:web:072ec41246a2d1027b6c3d"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Счётчики для уровней
    let levelCounts = {
      "Новичок": 0,
      "Опытный менеджер": 0,
      "Профессионал высокого уровня": 0
    };

    // Загружаем результаты и строим диаграмму
    db.collection("results")
      .orderBy("timestamp", "desc")
      .get()
      .then(snapshot => {
        const list = document.getElementById('list');
        if (snapshot.empty) {
          list.innerHTML = "<p>Нет сохранённых результатов.</p>";
          return;
        }

        let html = '';
        let totalResults = snapshot.size;
        
        // Считаем количество по уровням
        snapshot.forEach(doc => {
          const data = doc.data();
          const name = data.firstName && data.lastName 
            ? `${data.firstName} ${data.lastName}`
            : "Аноним";
          const date = data.timestamp 
            ? new Date(data.timestamp.toDate()).toLocaleString('ru-RU')
            : 'Неизвестно';

          // Увеличиваем счётчик для уровня
          if (data.level && levelCounts.hasOwnProperty(data.level)) {
            levelCounts[data.level]++;
          }

          html += `
            <div class="result-item">
              <p><strong>${name}</strong> — ${data.level} (баллы: ${data.score})</p>
              <p><small>Дата: ${date}</small></p>
            </div>
          `;
        });
        
        list.innerHTML = html;
        
        // Строим диаграмму
        createChart(levelCounts, totalResults);
        
      })
      .catch(err => {
        console.error("Ошибка загрузки:", err);
        document.getElementById('list').innerHTML = "<p>Ошибка при загрузке данных.</p>";
      });

    // Функция создания круговой диаграммы
    function createChart(levelCounts, total) {
      const ctx = document.getElementById('levelChart').getContext('2d');
      
      // Данные для диаграммы
      const labels = Object.keys(levelCounts);
      const data = Object.values(levelCounts);
      const percentages = data.map(count => total > 0 ? ((count / total) * 100).toFixed(1) : 0);
      
      // Цвета для диаграммы в стиле программиста
      const colors = [
        'rgba(255, 99, 132, 0.8)',    // Красный для новичков
        'rgba(54, 162, 235, 0.8)',    // Синий для опытных
        'rgba(0, 255, 0, 0.8)'        // Зелёный для профессионалов
      ];
      
      const borderColors = [
        'rgba(255, 99, 132, 1)',
        'rgba(54, 162, 235, 1)',
        'rgba(0, 255, 0, 1)'
      ];
      
      const chart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: labels.map((label, i) => `${label} (${percentages[i]}%)`),
          datasets: [{
            data: data,
            backgroundColor: colors,
            borderColor: borderColors,
            borderWidth: 2,
            hoverOffset: 15
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                color: '#cccccc',
                font: {
                  family: "'Courier New', monospace",
                  size: 12
                },
                padding: 20
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.raw || 0;
                  const percentage = percentages[context.dataIndex];
                  return `${label.split(' (')[0]}: ${value} человек (${percentage}%)`;
                }
              },
              backgroundColor: 'rgba(45, 45, 45, 0.9)',
              titleColor: '#00ff00',
              bodyColor: '#cccccc',
              borderColor: '#00cc00',
              borderWidth: 1
            }
          }
        }
      });
      
      // Показываем статистику под диаграммой
      const statsElement = document.getElementById('chartStats');
      let statsHTML = '<div class="stats-grid">';
      
      labels.forEach((label, i) => {
        const count = data[i];
        const percent = percentages[i];
        const color = colors[i];
        
        statsHTML += `
          <div class="stat-item">
            <span class="stat-color" style="background-color: ${color}"></span>
            <span class="stat-label">${label}:</span>
            <span class="stat-value">${count} (${percent}%)</span>
          </div>
        `;
      });
      
      statsHTML += `
        <div class="stat-total">
          <span class="stat-label">Всего результатов:</span>
          <span class="stat-value">${total}</span>
        </div>
      </div>`;
      
      statsElement.innerHTML = statsHTML;
    }
  </script>
</body>
</html>

