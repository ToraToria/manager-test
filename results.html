<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤</title>
  <link rel="stylesheet" href="styles.css?v=1.5">
</head>
<body>
  <div class="container">
    <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Ç–µ—Å—Ç–∞</h2>
    
    <!-- –ü—Ä–æ—Å—Ç–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="simple-stats">
      <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
      <div id="statsInfo">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</div>
    </div>
    
    <!-- –°–ø–∏—Å–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
    <h3>–ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–π</h3>
    <div id="resultsList">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    
    <button onclick="window.location.href='index.html'" style="margin-top: 30px;">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –Ω–∞—á–∞–ª—É</button>
    <button onclick="window.location.href='test.html'" style="margin-top: 10px; background: rgba(0, 100, 255, 0.1);">–ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç –µ—â–µ —Ä–∞–∑</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAmTtXSLeksMmRuxlmt19qz60zESOCFGGY",
      authDomain: "manager-test-2b964.firebaseapp.com",
      projectId: "manager-test-2b964",
      storageBucket: "manager-test-2b964.firebasestorage.app",
      messagingSenderId: "769825814408",
      appId: "1:769825814408:web:072ec41246a2d1027b6c3d"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    db.collection("results")
      .orderBy("timestamp", "desc")
      .get()
      .then(snapshot => {
        const list = document.getElementById('resultsList');
        const stats = document.getElementById('statsInfo');
        
        if (snapshot.empty) {
          list.innerHTML = "<p class='no-results'>–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</p>";
          stats.innerHTML = "<p>–ü–æ–∫–∞ –Ω–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏. –ü—Ä–æ–π–¥–∏—Ç–µ —Ç–µ—Å—Ç –ø–µ—Ä–≤—ã–º!</p>";
          return;
        }

        let html = '';
        let totalResults = snapshot.size;
        
        // –°—á–µ—Ç—á–∏–∫–∏ –¥–ª—è —É—Ä–æ–≤–Ω–µ–π
        let levelCounts = {
          "–ù–æ–≤–∏—á–æ–∫": 0,
          "–û–ø—ã—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä": 0,
          "–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª –≤—ã—Å–æ–∫–æ–≥–æ —É—Ä–æ–≤–Ω—è": 0
        };
        
        // –°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª
        let totalScore = 0;

        // –°—á–∏—Ç–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        snapshot.forEach(doc => {
          const data = doc.data();
          const name = data.firstName && data.lastName 
            ? `${data.firstName} ${data.lastName}`
            : "–ê–Ω–æ–Ω–∏–º";
          const date = data.timestamp 
            ? new Date(data.timestamp.toDate()).toLocaleDateString('ru-RU')
            : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';

          // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫ –¥–ª—è —É—Ä–æ–≤–Ω—è
          if (data.level && levelCounts.hasOwnProperty(data.level)) {
            levelCounts[data.level]++;
          }
          
          // –°—á–∏—Ç–∞–µ–º –æ–±—â–∏–π –±–∞–ª–ª
          if (data.score) {
            totalScore += data.score;
          }

          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç —É—Ä–æ–≤–Ω—è
          let levelColor = '#ff6384'; // –ö—Ä–∞—Å–Ω—ã–π –¥–ª—è –Ω–æ–≤–∏—á–∫–∞
          if (data.level === "–û–ø—ã—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä") levelColor = '#36a2eb'; // –°–∏–Ω–∏–π
          if (data.level === "–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª –≤—ã—Å–æ–∫–æ–≥–æ —É—Ä–æ–≤–Ω—è") levelColor = '#00ff00'; // –ó–µ–ª–µ–Ω—ã–π

          html += `
            <div class="result-item" style="border-left: 4px solid ${levelColor}">
              <p><strong>${name}</strong> ‚Äî <span style="color: ${levelColor}">${data.level}</span> (–±–∞–ª–ª—ã: ${data.score})</p>
              <p><small>üìÖ ${date}</small></p>
            </div>
          `;
        });
        
        list.innerHTML = html;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        const averageScore = totalResults > 0 ? (totalScore / totalResults).toFixed(1) : 0;
        
        let statsHTML = `
          <div class="stats-summary">
            <div class="stat-box">
              <div class="stat-number">${totalResults}</div>
              <div class="stat-label">–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤</div>
            </div>
            <div class="stat-box">
              <div class="stat-number">${averageScore}</div>
              <div class="stat-label">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</div>
            </div>
          </div>
          
          <div class="levels-breakdown">
            <h4>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —É—Ä–æ–≤–Ω—è–º:</h4>
            <div class="level-item">
              <span class="level-dot" style="background: #ff6384"></span>
              <span>–ù–æ–≤–∏—á–æ–∫: ${levelCounts["–ù–æ–≤–∏—á–æ–∫"]} (${((levelCounts["–ù–æ–≤–∏—á–æ–∫"] / totalResults) * 100).toFixed(1)}%)</span>
            </div>
            <div class="level-item">
              <span class="level-dot" style="background: #36a2eb"></span>
              <span>–û–ø—ã—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä: ${levelCounts["–û–ø—ã—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä"]} (${((levelCounts["–û–ø—ã—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä"] / totalResults) * 100).toFixed(1)}%)</span>
            </div>
            <div class="level-item">
              <span class="level-dot" style="background: #00ff00"></span>
              <span>–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª: ${levelCounts["–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª –≤—ã—Å–æ–∫–æ–≥–æ —É—Ä–æ–≤–Ω—è"]} (${((levelCounts["–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª –≤—ã—Å–æ–∫–æ–≥–æ —É—Ä–æ–≤–Ω—è"] / totalResults) * 100).toFixed(1)}%)</span>
            </div>
          </div>
        `;
        
        stats.innerHTML = statsHTML;
        
      })
      .catch(err => {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", err);
        document.getElementById('resultsList').innerHTML = "<p class='error'>–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.</p>";
        document.getElementById('statsInfo').innerHTML = "<p class='error'>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</p>";
      });
  </script>
</body>
</html>
